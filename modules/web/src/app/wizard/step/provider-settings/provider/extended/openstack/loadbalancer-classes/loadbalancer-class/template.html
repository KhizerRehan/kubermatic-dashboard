<!--
Copyright 2025 The Kubermatic Kubernetes Platform contributors.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<div class="km-loadbalancer-tree-node">
  <!-- Tree Node Header (Class Name + Controls) -->
  <div class="km-tree-node-header"
       fxLayout="row"
       fxLayoutAlign="space-between center"
       fxLayoutGap="10px">

       
    <!-- Expandable Header with Class Name -->
    <div class="km-pointer"
         fxLayout="row"
         fxLayoutAlign="start center"
         fxLayoutGap="8px"
         fxFlex
         (click)="toggleExpansion()">
      <i class="km-icon-mask km-tree-toggle-icon"
         [class.km-icon-arrow-down]="expanded" 
         [class.km-icon-arrow-right]="!expanded"></i>

      <span class="km-class-name-text" *ngIf="form.get('name').value">
        {{form.get('name').value}}
      </span>
      <span class="km-class-name-text" *ngIf="!form.get('name').value">
        Unnamed Class {{index + 1}}
      </span>
    </div>

    <!-- Remove Button -->
    <button mat-icon-button
            type="button"
            color="warn"
            class="km-remove-class-btn"
            (click)="remove.emit()"
            [disabled]="!canRemove"
            matTooltip="Remove LoadBalancer Class">
      <i class="km-icon-mask km-icon-delete"></i>
    </button>
  </div>

  <!-- Expandable Configuration Section -->
  <div *ngIf="expanded"
       class="km-tree-node-content"
       [formGroup]="form"
       fxLayout="column"
       fxLayoutGap="15px">
    <!-- Name field (aligned with other fields) -->
    <mat-form-field>
      <mat-label>LoadBalancer Class Name</mat-label>
      <input matInput
             formControlName="name"
             type="text"
             placeholder="e.g., default, internal, external"
             autocomplete="off"
             required />
      <mat-error *ngIf="form.get('name').hasError('required')">
        <strong>Name is required</strong>
      </mat-error>
      <mat-error *ngIf="form.get('name').hasError('minlength')">
        Name must be at least 1 character
      </mat-error>
      <mat-hint>Required field</mat-hint>
    </mat-form-field>

    <div formGroupName="config"
         class="km-loadbalancer-config"
         fxLayout="column"
         fxLayoutGap="15px">
      <!-- Floating Network Configuration -->
      <km-combobox [required]="false"
                 [grouped]="false"
                 [options]="floatingNetworks"
                 [hint]="'Network for floating IPs'"
                 formControlName="floatingNetworkID"
                 [label]="getFloatingNetworksLabel()"
                 [valueFormatter]="getFloatingNetworkDisplayName.bind(this)"
                 (changed)="onFloatingNetworkChange($event)"
                 inputLabel="Select floating network..."
                 filterBy="name"
                 selectBy="id">
        <div *option="let network">{{network.name}} ({{network.id}})</div>
      </km-combobox>

      <km-combobox [required]="false"
                 [grouped]="false"
                 [options]="floatingSubnets"
                 [hint]="'Subnet for floating IPs (ID stored)'"
                 formControlName="floatingSubnetID"
                 [label]="getFloatingSubnetsLabel()"
                 [valueFormatter]="getFloatingSubnetDisplayName.bind(this)"
                 (changed)="onFloatingSubnetIDChange($event)"
                 inputLabel="Select floating subnet..."
                 filterBy="name"
                 selectBy="id">
        <div *option="let subnet">{{subnet.name}} ({{subnet.id}})</div>
      </km-combobox>

      <km-combobox [required]="false"
                 [grouped]="false"
                 [options]="floatingSubnets"
                 [hint]="'Subnet for floating IPs (name stored)'"
                 formControlName="floatingSubnet"
                 [label]="getFloatingSubnetsLabelByName()"
                 [valueFormatter]="getFloatingSubnetDisplayName.bind(this)"
                 (changed)="onFloatingSubnetChange($event)"
                 inputLabel="Select floating subnet..."
                 filterBy="name"
                 selectBy="name">
        <div *option="let subnet">{{subnet.name}} ({{subnet.id}})</div>
      </km-combobox>

      <mat-form-field>
        <mat-label>Floating Subnet Tags</mat-label>
        <mat-select formControlName="floatingSubnetTags"
                  multiple
                  panelClass="km-multiple-values-dropdown"
                  disableOptionCentering
                  (selectionChange)="onFloatingSubnetTagsChange($event.value)">
          <mat-option *ngFor="let tag of floatingSubnetTags"
                    [value]="tag">
            {{tag}}
          </mat-option>
        </mat-select>
        <mat-hint>Tags for subnet used to create floating IP</mat-hint>
      </mat-form-field>

      <km-combobox [required]="false"
                 [grouped]="false"
                 [options]="networks"
                 [hint]="'Network for load balancer'"
                 formControlName="networkID"
                 [label]="getNetworksLabel()"
                 [valueFormatter]="getNetworkDisplayName.bind(this)"
                 (changed)="onNetworkChange($event)"
                 inputLabel="Select network..."
                 filterBy="name"
                 selectBy="id">
        <div *option="let network">{{network.name}} ({{network.id}})</div>
      </km-combobox>

      <km-combobox [required]="false"
                 [grouped]="false"
                 [options]="subnets"
                 [hint]="'Subnet for load balancer'"
                 formControlName="subnetID"
                 [label]="getSubnetsLabel()"
                 [valueFormatter]="getSubnetDisplayName.bind(this)"
                 (changed)="onSubnetIDChange($event)"
                 inputLabel="Select subnet..."
                 filterBy="name"
                 selectBy="id">
        <div *option="let subnet">{{subnet.name}} ({{subnet.id}})</div>
      </km-combobox>

      <km-combobox [required]="false"
                 [grouped]="false"
                 [options]="memberSubnets"
                 [hint]="'Subnet for load balancer members'"
                 formControlName="memberSubnetID"
                 [label]="getMemberSubnetsLabel()"
                 [valueFormatter]="getMemberSubnetDisplayName.bind(this)"
                 (changed)="onMemberSubnetIDChange($event)"
                 inputLabel="Select member subnet..."
                 filterBy="name"
                 selectBy="id">
        <div *option="let subnet">{{subnet.name}} ({{subnet.id}})</div>
      </km-combobox>
    </div>
  </div>
  <hr />
</div>
