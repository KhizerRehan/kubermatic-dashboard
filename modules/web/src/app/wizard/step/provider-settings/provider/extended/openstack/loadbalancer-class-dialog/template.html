<!--
Copyright 2025 The Kubermatic Kubernetes Platform contributors.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<km-dialog-title>Configure LoadBalancer Classes</km-dialog-title>
<mat-dialog-content>
  <p class="km-dialog-context-description">Configure one or more LoadBalancer classes for your OpenStack cluster.</p>

  <!-- LoadBalancer Class Form -->
  <form [formGroup]="form"
        fxLayout="column"
        fxLayoutGap="15px">
    <mat-form-field>
      <mat-label>LoadBalancer Class Name</mat-label>
      <input matInput
             [formControlName]="Controls.Name"
             type="text"
             autocomplete="off"
             required>
      <mat-hint>Unique name for this loadbalancer class</mat-hint>
      <mat-error *ngIf="form.get(Controls.Name).errors?.required">
        Name is required.
      </mat-error>
      <mat-error *ngIf="form.get(Controls.Name).errors?.duplicateName">
        Name must be unique.
      </mat-error>
    </mat-form-field>

    <mat-form-field>
      <mat-label>Floating Network ID</mat-label>
      <mat-select [formControlName]="Controls.FloatingNetworkID">
        <mat-option *ngIf="isFloatingNetworksLoading"
                    disabled>
          <mat-spinner [diameter]="16"></mat-spinner> Loading...
        </mat-option>
        <mat-option *ngIf="!isFloatingNetworksLoading && !floatingNetworks?.length"
                    disabled>
          No floating networks available
        </mat-option>
        <mat-option *ngFor="let network of floatingNetworks"
                    [value]="network.id">
          {{ getNetworkDisplayName(network) }}
        </mat-option>
      </mat-select>
      <mat-hint>Select the floating network for external access</mat-hint>
    </mat-form-field>

    <mat-form-field>
      <mat-label>Floating Subnet Name</mat-label>
      <mat-select [formControlName]="Controls.FloatingSubnetName"
                  [disabled]="!form.get(Controls.FloatingNetworkID).value">
        <mat-option *ngIf="isFloatingSubnetsLoading"
                    disabled>
          <mat-spinner [diameter]="16"></mat-spinner> Loading...
        </mat-option>
        <mat-option *ngIf="!isFloatingSubnetsLoading && !form.get(Controls.FloatingNetworkID).value"
                    disabled>
          Select a floating network first
        </mat-option>
        <mat-option *ngIf="!isFloatingSubnetsLoading && form.get(Controls.FloatingNetworkID).value && !floatingSubnets?.length"
                    disabled>
          No subnets available
        </mat-option>
        <mat-option *ngFor="let subnet of floatingSubnets"
                    [value]="subnet.name">
          {{ getSubnetDisplayName(subnet) }}
        </mat-option>
      </mat-select>
      <mat-hint>Select floating subnet by name</mat-hint>
    </mat-form-field>

    <mat-form-field>
      <mat-label>Floating Subnet ID</mat-label>
      <input matInput
             [formControlName]="Controls.FloatingSubnetID"
             type="text"
             readonly
             disabled>
      <mat-hint>Auto-populated from subnet name selection</mat-hint>
    </mat-form-field>

    <mat-form-field>
      <mat-label>Floating Subnet Tags</mat-label>
      <mat-select [formControlName]="Controls.FloatingSubnetTags"
                  [disabled]="!form.get(Controls.FloatingNetworkID).value"
                  multiple
                  panelClass="km-multiple-values-dropdown">
        <mat-option *ngIf="isFloatingSubnetsLoading"
                    disabled>
          <mat-spinner [diameter]="16"></mat-spinner> Loading...
        </mat-option>
        <mat-option *ngIf="!isFloatingSubnetsLoading && !form.get(Controls.FloatingNetworkID).value"
                    disabled>
          Select a floating network first
        </mat-option>
        <mat-option *ngIf="!isFloatingSubnetsLoading && form.get(Controls.FloatingNetworkID).value && !floatingSubnets?.length"
                    disabled>
          No subnets available
        </mat-option>
        <mat-option *ngFor="let subnet of floatingSubnets"
                    [value]="subnet.name">
          {{ getSubnetDisplayName(subnet) }}
        </mat-option>
      </mat-select>
      <mat-hint>Select multiple tags to filter subnets (comma-separated in output)</mat-hint>
    </mat-form-field>

    <mat-form-field>
      <mat-label>Network ID</mat-label>
      <mat-select [formControlName]="Controls.NetworkID">
        <mat-option *ngIf="isNetworksLoading"
                    disabled>
          <mat-spinner [diameter]="16"></mat-spinner> Loading...
        </mat-option>
        <mat-option *ngIf="!isNetworksLoading && !networks?.length"
                    disabled>
          No networks available
        </mat-option>
        <mat-option *ngFor="let network of networks"
                    [value]="network.id">
          {{ getNetworkDisplayName(network) }}
        </mat-option>
      </mat-select>
      <mat-hint>Internal network for loadbalancer</mat-hint>
    </mat-form-field>

    <mat-form-field>
      <mat-label>Subnet ID</mat-label>
      <mat-select [formControlName]="Controls.SubnetID"
                  [disabled]="!form.get(Controls.NetworkID).value">
        <mat-option *ngIf="isSubnetsLoading"
                    disabled>
          <mat-spinner [diameter]="16"></mat-spinner> Loading...
        </mat-option>
        <mat-option *ngIf="!isSubnetsLoading && !form.get(Controls.NetworkID).value"
                    disabled>
          Select a network first
        </mat-option>
        <mat-option *ngIf="!isSubnetsLoading && form.get(Controls.NetworkID).value && !subnets?.length"
                    disabled>
          No subnets available
        </mat-option>
        <mat-option *ngFor="let subnet of subnets"
                    [value]="subnet.id">
          {{ getSubnetDisplayName(subnet) }}
        </mat-option>
      </mat-select>
      <mat-hint>Subnet for the loadbalancer</mat-hint>
    </mat-form-field>

    <mat-form-field>
      <mat-label>Member Subnet ID</mat-label>
      <mat-select [formControlName]="Controls.MemberSubnetID"
                  [disabled]="!form.get(Controls.NetworkID).value">
        <mat-option *ngIf="isMemberSubnetsLoading"
                    disabled>
          <mat-spinner [diameter]="16"></mat-spinner> Loading...
        </mat-option>
        <mat-option *ngIf="!isMemberSubnetsLoading && !form.get(Controls.NetworkID).value"
                    disabled>
          Select a network first
        </mat-option>
        <mat-option *ngIf="!isMemberSubnetsLoading && form.get(Controls.NetworkID).value && !memberSubnets?.length"
                    disabled>
          No member subnets available
        </mat-option>
        <mat-option *ngFor="let subnet of memberSubnets"
                    [value]="subnet.id">
          {{ getSubnetDisplayName(subnet) }}
        </mat-option>
      </mat-select>
      <mat-hint>Subnet where loadbalancer members are located</mat-hint>
    </mat-form-field>

    <div fxLayout="row"
         fxLayoutAlign="start center"
         fxLayoutGap="10px"
         class="form-buttons">
      <button mat-flat-button
              type="button"
              (click)="clearForm()">
        <span>Clear Form</span>
      </button>
      <button mat-flat-button
              type="button"
              [disabled]="!form.valid"
              (click)="addClass()">
        <i class="km-icon-mask km-icon-add"
           matButtonIcon></i>
        <span>Add Class</span>
      </button>
    </div>
  </form>


<!-- LoadBalancer Configured Classes -->
  <div class="loadbalancer-classes-section">
    <p class="km-text-muted">LoadBalancer Classes ({{openstackConfiguredClasses.length}})</p>
    <mat-divider></mat-divider>
    <table class="km-table"
           mat-table
           [dataSource]="openstackConfiguredClasses">
      <ng-container matColumnDef="number">
        <th mat-header-cell
            *matHeaderCellDef
            class="km-header-cell">#</th>
        <td mat-cell
            *matCellDef="let element; let i = index">{{i + 1}}</td>
      </ng-container>

      <ng-container matColumnDef="name">
        <th mat-header-cell
            *matHeaderCellDef
            class="km-header-cell p-15">Name</th>
        <td mat-cell
            *matCellDef="let element">{{element.name}}</td>
      </ng-container>

      <ng-container matColumnDef="floatingNetwork">
        <th mat-header-cell
            *matHeaderCellDef
            class="km-header-cell p-25">Floating Network</th>
        <td mat-cell
            *matCellDef="let element">
          <span [matTooltip]="element.config?.floatingNetworkID || ''"
                [matTooltipDisabled]="!element.config?.floatingNetworkID"
                class="km-pointer">
            {{getDisplayNameForNetworkID(element.config?.floatingNetworkID)}}
          </span>
        </td>
      </ng-container>

      <ng-container matColumnDef="network">
        <th mat-header-cell
            *matHeaderCellDef
            class="km-header-cell">Network</th>
        <td mat-cell
            *matCellDef="let element">
          <span [matTooltip]="element.config?.networkID || ''"
                [matTooltipDisabled]="!element.config?.networkID"
                class="km-pointer">
            {{getDisplayNameForNetworkID(element.config?.networkID)}}
          </span>
        </td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell
            *matHeaderCellDef
            class="km-header-cell">Action</th>
        <td mat-cell
            *matCellDef="let element; let i = index">
          <button mat-icon-button
                  type="button"
                  (click)="deleteClass(i)">
            <i class="km-icon-mask km-icon-delete"
               aria-hidden="true"></i>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row
          class="km-header-row"
          *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row
          *matRowDef="let row; columns: displayedColumns"
          class="km-mat-row"></tr>
    </table>

    <div class="km-row km-empty-list-msg"
         *ngIf="!openstackConfiguredClasses.length">No loadbalancer classes available.
    </div>
  </div>
</mat-dialog-content>
<mat-dialog-actions>
  <button mat-flat-button
          type="button"
          (click)="dialogRef.close()">
    Cancel
  </button>
  <button mat-flat-button
          type="button"
          kmThrottleClick
          (throttleClick)="onSave()">
    <i class="km-icon-mask km-icon-save"
       matButtonIcon></i>
    <span>Save Changes</span>
  </button>
</mat-dialog-actions>
